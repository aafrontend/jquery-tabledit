if(typeof jQuery==="undefined"){throw new Error("Tabledit requires jQuery library.")}(function(f){"use strict";f.fn.Tabledit=function(t){if(!this.is("table")){throw new Error("Tabledit only works when applied to a table.")}var l=this;var e={url:window.location.href,inputClass:"form-control input-sm",toolbarClass:"btn-toolbar",groupClass:"btn-group btn-group-sm",dangerClass:"danger",warningClass:"warning",mutedClass:"text-muted",eventType:"click",rowIdentifier:"id",hideIdentifier:false,autoFocus:true,editButton:true,deleteButton:true,saveButton:true,restoreButton:true,buttons:{edit:{class:"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-pencil"></span>',action:"edit"},delete:{class:"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-trash"></span>',action:"delete"},save:{class:"btn btn-sm btn-success",html:"Save"},restore:{class:"btn btn-sm btn-warning",html:"Restore",action:"restore"},confirm:{class:"btn btn-sm btn-danger",html:"Confirm"}},onDraw:function(){return},onSuccess:function(){return},onFail:function(){return},onAlways:function(){return},onAjax:function(){return}};var d=f.extend(true,e,t);var a="undefined";var s="undefined";var n="undefined";var i={columns:{identifier:function(){if(d.hideIdentifier){l.find("th:nth-child("+parseInt(d.columns.identifier[0])+1+"), tbody td:nth-child("+parseInt(d.columns.identifier[0])+1+")").hide()}var t=l.find("tbody td:nth-child("+(parseInt(d.columns.identifier[0])+1)+")");t.each(function(){var t='<span class="tabledit-span tabledit-identifier">'+f(this).text()+"</span>";var e='<input class="tabledit-input tabledit-identifier" type="hidden" name="'+d.columns.identifier[1]+'" value="'+f(this).text()+'" disabled>';f(this).html(t+e);f(this).parent("tr").attr(d.rowIdentifier,f(this).text())})},editable:function(){for(var e=0;e<d.columns.editable.length;e++){var t=l.find("tbody td:nth-child("+(parseInt(d.columns.editable[e][0])+1)+")");t.each(function(){var n=f(this).text();if(!d.editButton){f(this).css("cursor","pointer")}var t='<span class="tabledit-span">'+n+"</span>";switch(d.columns.editable[e][2]){case"textarea":input="<textarea ";f.each(d.columns.editable[e][3],function(t,e){input+=t+'="'+e+'" '});input+='class="tabledit-input '+d.inputClass+'" name="'+d.columns.editable[e][1]+'" style="display: none;" disabled>'+obj.text()+"</textarea>";break;case"multiselect":input='<select class="multiSelect tabledit-input '+d.inputClass+'" name="'+d.columns.editable[e][1]+'" style="display: none; width:auto;" disabled multiple >';var i="";if(typeof n=="undefined"||n==""){}else{i=n.split(", ")}f.each(JSON.parse(d.columns.editable[e][3]),function(t,e){if(f.inArray(e,i)>-1){input+='<option value="'+t+'" selected>'+e+"</option>"}else{input+='<option value="'+t+'">'+e+"</option>"}});input+="</select>";break;default:if(d.columns.editable[e].length<=2){input='<input class="tabledit-input '+d.inputClass+'" type="text" name="'+d.columns.editable[e][1]+'" value="'+obj.text()+'" style="display: none;" disabled>';break}else{input='<select class="tabledit-input '+d.inputClass+'" name="'+d.columns.editable[e][1]+'" style="display: none; width:auto;" disabled>';input+='<option value="">Select</option>';f.each(JSON.parse(d.columns.editable[e][2]),function(t,e){if(typeof e=="object"){input+='<optgroup label="'+t+'">';f.each(e,function(t,e){if(n===e){input+='<option value="'+t+'" selected>'+e+"</option>"}else{input+='<option value="'+t+'">'+e+"</option>"}});input+="</optgroup>"}else{if(n===e){input+='<option value="'+t+'" selected>'+e+"</option>"}else{input+='<option value="'+t+'">'+e+"</option>"}}});input+="</select>"}}f(this).html(t+input);f(this).addClass("tabledit-view-mode")})}},toolbar:function(){if(d.editButton||d.deleteButton){var t="";var e="";var n="";var i="";var a="";if(l.find("th.tabledit-toolbar-column").length===0){l.find("tr:first").append('<th class="tabledit-toolbar-column"></th>')}if(d.editButton){t='<button type="button" class="tabledit-edit-button '+d.buttons.edit.class+'" style="float: none;">'+d.buttons.edit.html+"</button>"}if(d.deleteButton){e='<button type="button" class="tabledit-delete-button '+d.buttons.delete.class+'" style="float: none;">'+d.buttons.delete.html+"</button>";a='<button type="button" class="tabledit-confirm-button '+d.buttons.confirm.class+'" style="display: none; float: none;">'+d.buttons.confirm.html+"</button>"}if(d.editButton&&d.saveButton){n='<button type="button" class="tabledit-save-button '+d.buttons.save.class+'" style="display: none; float: none;">'+d.buttons.save.html+"</button>"}if(d.deleteButton&&d.restoreButton){i='<button type="button" class="tabledit-restore-button '+d.buttons.restore.class+'" style="display: none; float: none;">'+d.buttons.restore.html+"</button>"}var s='<div class="tabledit-toolbar '+d.toolbarClass+'" style="text-align: left;">\n                                           <div class="'+d.groupClass+'" style="float: none;">'+t+e+"</div>\n                                           "+n+"\n                                           "+a+"\n                                           "+i+"\n                                       </div></div>";l.find("tbody>tr").append('<td style="white-space: nowrap; width: 1%;">'+s+"</td>")}}}};var o={view:function(t){var e=f(t).parent("tr");f(t).parent("tr").find(".tabledit-input.tabledit-identifier").prop("disabled",true);f(t).find(".tabledit-input").blur().hide().prop("disabled",true);f(t).find(".tabledit-span").show();f(t).addClass("tabledit-view-mode").removeClass("tabledit-edit-mode");if(d.editButton){e.find("button.tabledit-save-button").hide();e.find("button.tabledit-edit-button").removeClass("active").blur()}},edit:function(t){u.reset(t);var e=f(t).parent("tr");e.find(".tabledit-input.tabledit-identifier").prop("disabled",false);f(t).find(".tabledit-span").hide();var n=f(t).find(".tabledit-input");n.prop("disabled",false).show();if(d.autoFocus){n.focus()}f(t).addClass("tabledit-edit-mode").removeClass("tabledit-view-mode");if(d.editButton){e.find("button.tabledit-edit-button").addClass("active");e.find("button.tabledit-save-button").show()}}};var r={reset:function(t){f(t).each(function(){var t=f(this).find(".tabledit-input");var e=f(this).find(".tabledit-span").text();if(t.is("select")){t.find("option").filter(function(){return f.trim(f(this).text())===e}).attr("selected",true)}else{t.val(e)}o.view(this)})},submit:function(t){var e=b(d.buttons.edit.action);if(e===false){return}f(t).each(function(){var t=f(this).find(".tabledit-input");if(t.is("select")){f(this).find(".tabledit-span").text(t.find("option:selected").text())}else{f(this).find(".tabledit-span").text(t.val())}o.view(this)});a=f(t).parent("tr")}};var u={reset:function(t){l.find(".tabledit-confirm-button").hide();l.find(".tabledit-delete-button").removeClass("active").blur()},submit:function(t){u.reset(t);f(t).parent("tr").find("input.tabledit-identifier").attr("disabled",false);var e=b(d.buttons.delete.action);f(t).parents("tr").find("input.tabledit-identifier").attr("disabled",true);if(e===false){return}f(t).parent("tr").addClass("tabledit-deleted-row");f(t).parent("tr").addClass(d.mutedClass).find(".tabledit-toolbar button:not(.tabledit-restore-button)").attr("disabled",true);f(t).find(".tabledit-restore-button").show();s=f(t).parent("tr")},confirm:function(t){l.find("td.tabledit-edit-mode").each(function(){r.reset(this)});f(t).find(".tabledit-delete-button").addClass("active");f(t).find(".tabledit-confirm-button").show()},restore:function(t){f(t).parent("tr").find("input.tabledit-identifier").attr("disabled",false);var e=b(d.buttons.restore.action);f(t).parents("tr").find("input.tabledit-identifier").attr("disabled",true);if(e===false){return}f(t).parent("tr").removeClass("tabledit-deleted-row");f(t).parent("tr").removeClass(d.mutedClass).find(".tabledit-toolbar button").attr("disabled",false);f(t).find(".tabledit-restore-button").hide();n=f(t).parent("tr")}};function b(i){var t=l.find(".tabledit-input").serialize();if(!t){return false}t+="&action="+i;var e=d.onAjax(i,t);if(e===false){return false}var n=f.post(d.url,t,function(t,e,n){if(i===d.buttons.edit.action){a.removeClass(d.dangerClass).addClass(d.warningClass);setTimeout(function(){l.find("tr."+d.warningClass).removeClass(d.warningClass)},1400)}d.onSuccess(t,e,n)},"json");n.fail(function(t,e,n){if(i===d.buttons.delete.action){s.removeClass(d.mutedClass).addClass(d.dangerClass);s.find(".tabledit-toolbar button").attr("disabled",false);s.find(".tabledit-toolbar .tabledit-restore-button").hide()}else if(i===d.buttons.edit.action){a.addClass(d.dangerClass)}d.onFail(t,e,n)});n.always(function(){d.onAlways()});return n}i.columns.identifier();i.columns.editable();i.columns.toolbar();d.onDraw();if(d.deleteButton){l.on("click","button.tabledit-delete-button",function(t){if(t.handled!==true){t.preventDefault();var e=f(this).hasClass("active");var n=f(this).parents("td");u.reset(n);if(!e){u.confirm(n)}t.handled=true}});l.on("click","button.tabledit-confirm-button",function(t){if(t.handled!==true){t.preventDefault();var e=f(this).parents("td");u.submit(e);t.handled=true}})}if(d.restoreButton){l.on("click","button.tabledit-restore-button",function(t){if(t.handled!==true){t.preventDefault();u.restore(f(this).parents("td"));t.handled=true}})}if(d.editButton){l.on("click","button.tabledit-edit-button",function(t){if(t.handled!==true){t.preventDefault();var e=f(this);var n=e.hasClass("active");r.reset(l.find("td.tabledit-edit-mode"));if(!n){f(e.parents("tr").find("td.tabledit-view-mode").get().reverse()).each(function(){o.edit(this)})}t.handled=true}});l.on("click","button.tabledit-save-button",function(t){if(t.handled!==true){t.preventDefault();r.submit(f(this).parents("tr").find("td.tabledit-edit-mode"));t.handled=true}})}else{l.on(d.eventType,"tr:not(.tabledit-deleted-row) td.tabledit-view-mode",function(t){if(t.handled!==true){t.preventDefault();r.reset(l.find("td.tabledit-edit-mode"));o.edit(this);t.handled=true}});l.on("change","select.tabledit-input:visible",function(t){if(t.handled!==true){r.submit(f(this).parent("td"));t.handled=true}});f(document).on("click",function(t){var e=l.find(".tabledit-edit-mode");if(!e.is(t.target)&&e.has(t.target).length===0){r.reset(l.find(".tabledit-input:visible").parent("td"))}})}l.on("keyup",function(t){var e=l.find(".tabledit-input:visible");var n=l.find(".tabledit-confirm-button");if(e.length>0){var i=e.parents("td")}else if(n.length>0){var i=n.parents("td")}else{return}switch(t.keyCode){case 9:if(!d.editButton){r.submit(i);o.edit(i.closest("td").next())}break;case 13:r.submit(i);break;case 27:r.reset(i);u.reset(i);break}});return this}})(jQuery);